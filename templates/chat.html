{% extends 'layout.html' %}
{% block body %}
        
        <section class="chat-area"  id="chat-message">
           <header>
               <a href="/userlist" class="back-icon"><i class="fa fa-arrow-left"></i></a>
               {%for user in chatusers %}
                    {% if user.Name == session.name %}
                        <div class="details">
                            <span>{{user.Name}}</span>
                            <p>Active now</p>
                        </div>
                    {% endif %}
                {% endfor %}
           </header>
           <div class="chat-box"  >
               {% for message in messages %}
                    {% if message.outgoing_msg_id == session.user%}
                        <div class="chat outgoing">
                            <div class="details">
                                <p>{{message.msg}}</p>
                            </div>
                        </div>
                    {% else %}
                
                        <div class="chat incoming">
                             <div class="details">
                                <p>{{message.msg}}</p>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
           </div>
           <form action="#" method="POST"class="typing-area">
               <input type="text" name="outgoing_id" value="{{session.user}}" hidden>
               <input type="text" name="incoming_id" value="{{session.name}}" hidden>
               <input type="text" class="input-field" name="message" placeholder="type a message here....">
               <button><i class="fab fa-telegram-plane"></i></button>

           </form>
            
        </section>

        <script type="text/javascript">
        

            const form = document.querySelector(".typing-area"),
            inputField = document.querySelector(".input-field"),
            sendBtn = document.querySelector("button"),
            chatBox = document.querySelector("#chat-message");
  
            form.onsubmit = (e)=> {
                e.preventDefault();
            }
            sendBtn.onclick = ()=> {
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/chat/<string:name>')
                xhr.onload =() => {
                    if (xhr.readyState == XMLHttpRequest.DONE){
                        if(xhr.status == 200){
                            inputField.value = "";
                        }
                    }
                }
                let formData = new FormData(form);
                xhr.send(formData);
            }

            setTimeout(() => {
                 let xhr = new XMLHttpRequest();
                 xhr.open('POST', '/messages')
                 xhr.onload =() => {
                     if (xhr.readyState == XMLHttpRequest.DONE){
                            if(xhr.status == 200){
                                let data = xhr.response;
                                chatBox.innerHTML = data;
                        }
                    }
                }
                let formData = new FormData(form);
                xhr.send(formData);
            }, 500);
            
/*

            function ajax(){
                xmlhttp = new XMLHttpRequest();
                xmlhttp.open('GET','/messages',false);
                xmlhttp.send(null);
                document.getElementById("chat-message").innerHTML=xmlhttp.responseText;

            }
            ajax();
            var myVar = setInterval(ajax, 3000);
           

                


            function ajax(){
                

                    var req = new XMLHttpRequest();
                    req.onreadystatechange = function(){
                    if(req.readyState == 4 && req.status == 200){
                        document.querySelector('chats-box').innerHTML = req.responseText;
                        }
                    }
                        req.open('POST', '/chats', true);
                        req.send();
                    }
                    setInterval(function(){ajax()}, 500);
            
 
             setInterval(() => {
                 let xhr = new XMLHttpRequest();
                 xhr.open('POST', '/chat')
                 xhr.onload =() => {
                     if (xhr.readyState == XMLHttpRequest.DONE){
                            if(xhr.status == 200){
                                let data = xhr.response;
                                chatBox.innerHTML = data;
                        }
                    }
                }
                let formData = new FormData(form);
                xhr.send(formData);
            }, 500);

            sendBtn.onclick = ()=> {
                let xhr = new XMLHttpRequest();
                xhr.open('POST', '/chat/<string:name>')
                xhr.onload =() => {
                    if (xhr.readyState == XMLHttpRequest.DONE){
                        if(xhr.status == 200){
                            let data = xhr.response;
                            console.log(data)
                            
                        }
                    }
                }
                let formData = new FormData(form);
                xhr.send(formData);
            }
            */
            
         </script>
{% endblock %}